# syntax=docker-registry.wikimedia.org/repos/releng/blubber:v0.17.0
version: v4
base: docker-registry.wikimedia.org/openjdk-11-jdk

lives:
  in: /datahub/datahub-gms

variants:
  datahub-source:
    lives:
      in: /datahub
    base: docker-registry.wikimedia.org/bullseye:latest
    apt:
      packages: [ 'git', 'ca-certificates' ]
    builders:
      - custom:
          command:
            - git
            - clone
            - '--branch'
            - 'v0.10.4'
            - '--single-branch'
            - "https://github.com/datahub-project/datahub.git"
            - "/datahub"
      - custom:
          command:
            - chmod
            - +x
            - /datahub/docker/datahub-gms/start.sh

  dockerize:
    base: docker-registry.wikimedia.org/golang1.19:1.19-1-20230625
    builders:
      - custom:
          command: [ 'go', 'install', 'github.com/jwilder/dockerize@v0.6.1']

  build:
    lives:
      in: /datahub
    builder:
      command: ['./gradlew', ':metadata-service:war:build']
      requirements:
      - from: datahub-source
        source: /datahub
        destination: /datahub
        
  prepare:
    copies:
      - from: build
        source: /datahub/metadata-service/war/build/libs/war.war
        destination: /datahub/datahub-gms/bin/war.war
      - from: build
        source: /datahub/docker/datahub-gms/start.sh
        destination: /datahub/datahub-gms/scripts/start.sh
      - from: build
        source: /datahub/docker/datahub-gms/jetty.xml
        destination: /datahub/datahub-gms/scripts/jetty.xml
      - from: build
        source: /datahub/metadata-models/src/main/resources/entity-registry.yml
        destination: /datahub/datahub-gms/resources/entity-registry.yml
      - from: build
        source: /datahub/docker/monitoring/client-prometheus-config.yaml
        destination: /datahub/datahub-gms/scripts/prometheus-config.yaml
    apt: { packages: [ curl, wget ] }
    builders:
      - custom:
          command: [ 'curl', '-sS', 'https://repo1.maven.org/maven2/org/eclipse/jetty/jetty-runner/9.4.46.v20220331/jetty-runner-9.4.46.v20220331.jar', '--output', '/tmp/jetty-runner.jar']
      - custom:
          command: [ 'curl', '-sS', 'https://repo1.maven.org/maven2/org/eclipse/jetty/jetty-jmx/9.4.46.v20220331/jetty-jmx-9.4.46.v20220331.jar', '--output', '/tmp/jetty-jmx.jar']
      - custom:
          command: [ 'curl', '-sS', 'https://repo1.maven.org/maven2/org/eclipse/jetty/jetty-util/9.4.46.v20220331/jetty-util-9.4.46.v20220331.jar', '--output', '/tmp/jetty-util.jar']
      - custom:
          command: [ 'wget', '--no-verbose' ,'https://github.com/open-telemetry/opentelemetry-java-instrumentation/releases/download/v1.24.0/opentelemetry-javaagent.jar', '-O', '/tmp/opentelemetry-javaagent.jar']
      - custom:
          command: [ 'wget', '--no-verbose' ,'https://repo1.maven.org/maven2/io/prometheus/jmx/jmx_prometheus_javaagent/0.18.0/jmx_prometheus_javaagent-0.18.0.jar', '-O', '/tmp/jmx_prometheus_javaagent.jar']
      - custom:
          command: [ 'mkdir', '-p', 'plugins/auth/resources']

  production:
    apt:
      sources:
        - url: http://apt.wikimedia.org/wikimedia
          distribution: bullseye-wikimedia
          components: [main]
      packages: [ wmf-certificates ]
    copies:
      - from: prepare
        source: /datahub/datahub-gms
        destination: /datahub/datahub-gms
      - from: prepare
        source: /tmp/jetty-runner.jar
        destination: /
      - from: prepare
        source: /tmp/jetty-jmx.jar
        destination: /
      - from: prepare
        source: /tmp/jetty-util.jar
        destination: /
      - from: prepare
        source: /tmp/opentelemetry-javaagent.jar
        destination: /
      - from: prepare
        source: /tmp/jmx_prometheus_javaagent.jar
        destination: /
      - from: dockerize
        source: /go/bin/dockerize
        destination: /usr/local/bin
    entrypoint: ['/bin/sh', '-c', 'cd / && /datahub/datahub-gms/scripts/start.sh']
