# syntax=docker-registry.wikimedia.org/repos/releng/blubber:v0.12.1
version: v4
base: docker-registry.wikimedia.org/openjdk-11-jdk

lives:
  in: /datahub/datahub-mce-consumer

variants:
  build:
    lives:
      in: /datahub/src
    builder:
      command: ['./gradlew', ':metadata-jobs:mce-consumer-job:build']
      requirements:
       - from: local
         source: .
         destination: .
  prepare:
    copies:
     - from: build
       source: /datahub/src/metadata-jobs/mce-consumer-job/build/libs/mce-consumer-job.jar
       destination: /datahub/datahub-mce-consumer/mce-consumer-job.jar
     - from: build
       source: /datahub/src/docker/monitoring/client-prometheus-config.yaml
       destination: /datahub/datahub-mce-consumer/scripts/prometheus-config.yaml
    apt: { packages: [curl] }
    builder:
      command: ['/bin/bash', '/datahub/datahub-mce-consumer/setup_mce_consumer.sh']
      requirements:
      - from: build
        source: /datahub/src/docker/datahub-mce-consumer/setup_mce_consumer.sh
        destination: /datahub/datahub-mce-consumer/setup_mce_consumer.sh
      - from: build
        source: /datahub/src/docker/datahub-mce-consumer/start.sh
        destination: /datahub/datahub-mce-consumer/scripts/start.sh
  production:
    apt:
      sources:
        - url: http://apt.wikimedia.org/wikimedia
          distribution: buster-wikimedia
          components: [main]
      packages: [ wmf-certificates ]
    copies:
     - from: prepare
       source: /datahub/datahub-mce-consumer
       destination: /datahub/datahub-mce-consumer
    entrypoint: ['/datahub/datahub-mce-consumer/scripts/start.sh']
