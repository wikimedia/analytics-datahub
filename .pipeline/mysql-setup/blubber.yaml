# syntax=docker-registry.wikimedia.org/repos/releng/blubber:v0.17.0
version: v4
base: docker-registry.wikimedia.org/bullseye
lives:
  in: /datahub
runs:
  environment:
    DATAHUB_DB_NAME: datahub

variants:
  datahub-source:
    lives:
      in: /datahub
    base: docker-registry.wikimedia.org/bullseye:latest
    apt:
      packages: [ 'git', 'ca-certificates' ]
    builders:
      - custom:
          command:
            - git
            - clone
            - '--branch'
            - 'v0.10.4'
            - '--single-branch'
            - "https://github.com/datahub-project/datahub.git"
            - "/datahub"
      - custom:
          command:
            - chmod
            - +x
            - /datahub/docker/mysql-setup/init.sh

  dockerize:
    base: docker-registry.wikimedia.org/golang1.19:1.19-1-20230625
    builder:
      command: [ 'go', 'install', 'github.com/jwilder/dockerize@v0.6.1']

  production:
    apt:
      sources:
        - url: http://apt.wikimedia.org/wikimedia
          distribution: bullseye-wikimedia
          components: [main]
      packages: [ wmf-certificates, mariadb-client ]
    copies:
    - from: datahub-source
      source: /datahub/docker/mysql-setup/init.sql
      destination: /init.sql
    - from: datahub-source
      source: /datahub/docker/mysql-setup/init.sh
      destination: /init.sh
    - from: dockerize
      source: /go/bin/dockerize
      destination: /usr/local/bin
    entrypoint:
     - /bin/bash
     - -c
     - dockerize -wait tcp://$MYSQL_HOST:$MYSQL_PORT -timeout 240s /init.sh
